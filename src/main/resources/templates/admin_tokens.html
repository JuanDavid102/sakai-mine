<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <title th:text="#{admin_token_manager_title}">Token Manager</title>
  <div th:insert="fragments/head :: head"></div>
</head>

<body>
  <div class="admin-container">
    <!-- Topbar -->
    <div th:insert="fragments/topbar :: topbar (admin_tokens)"></div>
    <!-- End of Topbar -->

    <h2 class="canvas-h2" th:text="#{admin_sidebar_token_manahement}">Token Management</h2>
    <div id="invalidTokenBanner" class="alert alert-danger" style="display:none;" role="alert" th:text="#{admin_token_invalid}"></div>
    <div class="text-left"> 
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addTokenModal" th:text="#{admin_token_add_new_token}">Add new token</button>
    </div>
    <div class="modal fade" id="addTokenModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addClassModalLabel">Add new token</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning" th:text="#{admin_token_info}"></div>
            <form id="addTokenForm" th:action="@{/saveToken}" method="post">
              <div class="form-group">
                <label for="token" th:text="#{admin_token_name}">Token:</label>
                <input type="text" id="token" class="form-control" name="token" required="true"/>
              </div>
              <button type="submit" class="btn btn-primary"><i class="glyphicon glyphicon-ok"></i><span th:text="#{admin_token_add_new_token}">Save</span></button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal" th:text="#{admin_token_cancel}"></button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="alert alert-warning" role="alert" th:if="${tokenList.isEmpty()}" th:text="#{admin_token_empty_list}"></div>
    <table th:if="${!tokenList.isEmpty()}" id="tokenTable" class="table table-striped table-hovered table-bordered">
      <thead>
        <tr>
          <th th:text="#{admin_token_header_token}">Token</th>
          <th th:text="#{admin_token_header_status}">Status</th>
          <th th:text="#{admin_token_header_created_date}">User</th>
          <th th:text="#{admin_token_header_created_by}">Date</th>
          <th th:text="#{admin_token_header_delete}">Delete</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="token : ${tokenList}">
          <td th:text="${token.token}"></td>
          <td><i th:if="${token.status}" class="fas fa-check" th:title="#{admin_token_status_ok}"></i><i th:if="!${token.status}" class="fas fa-exclamation-circle" th:title="#{admin_token_status_ko}"></i></td>
          <td th:text="${token.createdDate}"></td>
          <td th:text="${token.createdBy}"></td>
          <td><button th:id="${token.token}" class="btn btn-primary" onclick="deleteToken(this);"><span th:text="#{admin_token_delete}">Delete token</span></button></td>
        </tr>
      </tbody>
    </table>
  </div><!-- End of container -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    $('#addTokenForm').submit(function(e) {
      e.preventDefault();
      $('#addTokenModal').modal('toggle');
      var newToken = $('#token').val();
      $.ajax({
        url: [[@{/saveToken}]]  + '?token=' + newToken,
        type: 'POST',
        contentType: 'text/plain; charset=utf-8'
      }).done(function() {
        console.debug('Token save successfully...');
        document.location.reload();
      }).fail(function () {
        console.debug('Error saving token...');
        $('#invalidTokenBanner').show();
      });
    });

    function deleteToken(token) {
      var tokenId = token.id;
      $.ajax({
        url: [[@{/deleteToken}]]  + '?token=' + tokenId,
        type: 'POST',
        contentType: 'text/plain; charset=utf-8'
      }).done(function() {
        console.debug('Token deleted successfully...');
        document.location.reload();
      }).fail(function () {
        console.debug('Error deleting token...');
      });
    }
    /*]]>*/
  </script>
</body>
</html>

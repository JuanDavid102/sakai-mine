<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <title th:text="#{instructor_view_title}">LTI Gradebook Home</title>
<body>

<div class="alert alert-info" th:if="${assignmentList.isEmpty()}" th:text="#{shared_no_assignments}">
  There are no assignments in this course.
</div>

<div class="alert alert-success" th:if="${errors != null}" th:text="#{instructor_import_success_msg}">
  CSV file imported successfully.
</div>

<div class="alert alert-warning" th:if="${errors != null && errors}" th:text="#{instructor_import_errors_msg}">
  One or some grades in the CSV file could not be saved due to an error in them.
</div>

<div class="alert alert-warning" th:if="${groupWeightsNot100}" th:text="#{instructor_weights_not_100}">
  The sum of group weights belonging this course does not add up to 100%.
</div>

<div class="table-container" id="tableContainer">
  <div class="top-bar row">
    <div class="top-bar-left col-md-3">
      <input type="text" id="studentFilter" class="canvas-input" th:placeholder="#{instructor_filter_placeholder}" />
    </div>
    <div class="top-bar-right col-md-9">
      <div class="canvas-btn-group">
        <select id="conversionScaleSelector" class="canvas-btn" name="conversionScaleSelector">
            <option value="FIFTY" th:selected="${'0.5'==coursePreference.conversionScale}"><span th:text="#{instructor_conversion_scale(' 50%')}"></span></option>
            <option value="SIXTY" th:selected="${'0.6'==coursePreference.conversionScale}"><span th:text="#{instructor_conversion_scale(' 60%')}"></span></option>
            <option value="SEVENTY" th:selected="${'0.7'==coursePreference.conversionScale}"><span th:text="#{instructor_conversion_scale(' 70%')}"></span></option>
            <option value="EIGHTY" th:selected="${'0.8'==coursePreference.conversionScale}"><span th:text="#{instructor_conversion_scale(' 80%')}"></span></option>
            <option value="NINETY" th:selected="${'0.9'==coursePreference.conversionScale}"><span th:text="#{instructor_conversion_scale(' 90%')}"></span></option>
        </select>
      </div>
      <div class="canvas-btn-group">
        <button class="canvas-btn" th:title="#{instructor_option_audit}" id="auditLogModalButton" data-toggle="modal" data-target="#auditLog">
          <span class="fas fa-history"></span>
          <span class="d-none d-sm-inline-block" th:text="#{instructor_option_audit}">Audit Log</span>
        </button>
      </div>
      <div class="canvas-btn-group">
        <button class="canvas-btn" th:title="#{instructor_option_import}" data-toggle="modal" data-target="#importCsv">
          <span class="fas fa-file-import"></span>
          <span class="d-none d-sm-inline-block" th:text="#{instructor_option_import}">Import</span>
        </button>
        <button class="canvas-btn" th:title="#{instructor_option_export}" data-toggle="modal" data-target="#exportCsv">
          <span class="fas fa-file-export"></span>
          <span class="d-none d-sm-inline-block" th:text="#{instructor_option_export}">Export</span>
          <div class="spinner-border" role="status">
            <span class="sr-only" th:text="#{instructor_spinner_loading}">Loading</span>
          </div>
        </button>
      </div>
      <div class="canvas-btn-group" th:if="${isBannerEnabled}">
        <a class="canvas-btn" href="#" data-toggle="modal" data-target="#sendGrades" th:title="#{instructor_send_grades_banner}">
          <span class="fas fa-graduation-cap"></span>
          <span class="d-none d-sm-inline-block" th:text="#{instructor_send_grades_banner}">Send grades to banner</span>
        </a>
      </div>
      <div class="canvas-btn-group" th:if="${isAdminUser}">
        <a class="canvas-btn" href="/admin_main" th:href="@{/admin_main}" th:title="#{instructor_option_admin}">
          <span class="fas fa-cog"></span>
        </a>
      </div>
    </div>
  </div>
  <div th:id="${'studentTable' + courseId}" th:if="${!assignmentList.isEmpty()}" class="studentTable"></div>

  <!-- Modal Audit Log -->
  <div class="modal fade" id="auditLog" tabindex="-1" role="dialog" aria-labelledby="auditLogModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="auditLogModalLabel" th:text="#{instructor_option_audit}">Audit Log</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center" id="auditLogBody">
          <div class="spinner-border" role="status">
            <span class="sr-only" th:text="#{instructor_spinner_loading}">Loading</span>
          </div>
          <div id="auditLogTableContainer" class="text-left"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="canvas-btn rounded-btn" data-dismiss="modal" th:text="#{instructor_import_modal_close}">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Import -->
  <div class="modal fade" id="importCsv" tabindex="-1" role="dialog" aria-labelledby="importCsvModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importCsvModalLabel" th:text="#{instructor_import_modal_title(${courseName})}">Import Gradebook</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="import-error" role="alert" th:text="#{instructor_import_modal_error}">Invalid CSV file. Failed to update course grades.</div>
          <form th:action="@{/import_csv}" class="dropzone" id="file-dropzone"></form>
        </div>
        <div class="modal-footer">
          <button type="button" class="canvas-btn rounded-btn" data-dismiss="modal" th:text="#{instructor_import_modal_cancel}">Cancel</button>
          <button type="button" id="submitCsv" class="canvas-btn rounded-btn primary-btn" disabled="true">
            <span th:text="#{instructor_import_modal_import}">Import</span>
            <div class="spinner-border" role="status">
              <span class="sr-only" th:text="#{instructor_spinner_loading}">Loading</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Export -->
  <div class="modal fade" id="exportCsv" tabindex="-1" role="dialog" aria-labelledby="exportCsvModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportCsvModalLabel" th:text="#{instructor_export_modal_title(${courseName})}">Export Gradebook</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="exportCsvSection" th:text="#{instructor_export_modal_label_section}">Filter by section</label>
            <select class="form-control" name="sectionId" id="exportCsvSection">
              <option value="all" th:text="#{instructor_export_modal_all_sections}">All sections</option>
              <option th:each="section : ${sectionList}" th:value="${section.id}" th:text="${section.name}"></option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="canvas-btn rounded-btn" data-dismiss="modal" th:text="#{instructor_export_modal_close}">Close</button>
          <button type="button" id="export-button" class="canvas-btn rounded-btn primary-btn">
            <span th:text="#{instructor_export_modal_export}">Export</span>
            <div class="spinner-border" role="status">
              <span class="sr-only" th:text="#{instructor_spinner_loading}">Loading</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Assignment Details -->
  <div class="modal fade" id="assignmentDetails" tabindex="-1" role="dialog" aria-labelledby="assignmentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="assignmentDetailsModalLabel"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-7"><span th:text="#{instructor_details_modal_label_mean}"></span></div>
            <div class="col-sm-5"><span id="meanValue"></span></div>
          </div>
          <div class="row">
            <div class="col-sm-7"><span th:text="#{instructor_details_modal_label_max}"></span></div>
            <div class="col-sm-5"><span id="maxValue"></span></div>
          </div>
          <div class="row">
            <div class="col-sm-7"><span th:text="#{instructor_details_modal_label_min}"></span></div>
            <div class="col-sm-5"><span id="minValue"></span></div>
          </div>
          <div class="row">
            <div class="col-sm-7"><span th:text="#{instructor_details_modal_label_total}"></span></div>
            <div class="col-sm-5"><span id="totalGraded"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Group Details -->
  <div class="modal fade" id="groupDetails" tabindex="-1" role="dialog" aria-labelledby="groupDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="groupDetailsModalLabel"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-7"><span th:text="#{instructor_details_modal_label_mean}"></span></div>
            <div class="col-sm-5"><span id="meanValue"></span></div>
          </div>
          <div class="row">
            <div class="col-sm-7"><span th:text="#{instructor_details_modal_label_max}"></span></div>
            <div class="col-sm-5"><span id="maxValue"></span></div>
          </div>
          <div class="row">
            <div class="col-sm-7"><span th:text="#{instructor_details_modal_label_min}"></span></div>
            <div class="col-sm-5"><span id="minValue"></span></div>
          </div>
          <div class="row">
            <div class="col-sm-7"><span th:text="#{instructor_details_modal_label_total}"></span></div>
            <div class="col-sm-5"><span id="totalGraded" th:attr="data-template=#{instructor_details_modal_total}"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Assignment Scale -->
  <div class="modal fade" id="assignmentScale" tabindex="-1" role="dialog" aria-labelledby="assignmentScaleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="assignmentConversionScale" th:text="#{instructor_assignment_scale_modal_label}">Conversion scale</label>
            <select class="form-control" name="assignmentConversionScale" id="assignmentConversionScale">
              <option value="" th:text="#{instructor_assignment_scale_modal_none_option}">Use course conversion scale</option>
              <option value="0.5"><span th:text="#{instructor_conversion_scale(' 50%')}"></span></option>
              <option value="0.6"><span th:text="#{instructor_conversion_scale(' 60%')}"></span></option>
              <option value="0.7"><span th:text="#{instructor_conversion_scale(' 70%')}"></span></option>
              <option value="0.8"><span th:text="#{instructor_conversion_scale(' 80%')}"></span></option>
              <option value="0.9"><span th:text="#{instructor_conversion_scale(' 90%')}"></span></option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="canvas-btn rounded-btn" data-dismiss="modal" th:text="#{instructor_export_modal_close}">Close</button>
          <button type="button" id="save-assignment-scale-button" class="canvas-btn rounded-btn primary-btn">
            <span th:text="#{save}">Save</span>
            <div class="spinner-border" role="status">
              <span class="sr-only" th:text="#{instructor_spinner_loading}">Loading</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Send Message -->
  <div class="modal fade" id="sendMessage" tabindex="-1" role="dialog" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sendMessageModalLabel"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="messageTypes" th:text="#{instructor_dropdown_send_message}">Message students who...</label>
            <select class="form-control" name="messageTypes" id="messageTypes">
              <!--option value="0" th:text="#{instructor_send_message_type_0}">Haven't submitted yet</option-->
              <option value="1" th:text="#{instructor_send_message_type_1}">Haven't been graded</option>
              <option value="2" th:text="#{instructor_send_message_type_2}">Scored less than</option>
              <option value="3" th:text="#{instructor_send_message_type_3}">Scored more than</option>
            </select>
          </div>
          <div class="cutoff_score_container form-group row d-none">
            <div class="input-group col-sm-4">
              <input type="text" class="form-control" name="cutoff_score" id="cutoff_score" />
              <div class="input-group-append">
                <span class="input-group-text total-points" th:text="#{instructor_send_message_modal_out_of_7}">out of 7</span>
              </div>
            </div>
          </div>
          <ul id="send-message-users" class="list-group list-group-flush mb-3">
            
          </ul>
          <div class="form-group">
            <label for="subject" th:text="#{instructor_send_message_modal_subject}">Subject</label>
            <input type="text" class="form-control" name="sendMessageSubject" id="sendMessageSubject" />
          </div>
          <div>
            <label for="message" th:text="#{instructor_send_message_modal_message}">Message</label>
            <textarea class="form-control" name="sendMessageTextarea" id="sendMessageTextarea" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="canvas-btn rounded-btn" data-dismiss="modal" th:text="#{instructor_export_modal_close}">Close</button>
          <button type="button" id="send-message-button" class="canvas-btn rounded-btn primary-btn" disabled="disabled">
            <span th:text="#{send_message}">Send message</span>
            <div class="spinner-border" role="status">
              <span class="sr-only" th:text="#{instructor_spinner_loading}">Loading</span>
            </div>
          </button>
        </div>
        <input type="hidden" id="send-message-assignment-name" />
        <input type="hidden" id="send-message-assignment-id" />
        <input type="hidden" id="send-message-user-ids" />
        <input type="hidden" id="selected-column" />
      </div>
    </div>
  </div>
</div>

  <!-- Modal Send Grades To Banner -->
  <div class="modal fade" id="sendGrades" tabindex="-1" role="dialog" aria-labelledby="sendGradesModalLabel" aria-hidden="true" th:if="${isBannerEnabled}">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form th:action="@{/send_to_banner}" method="GET">
          <div class="modal-header">
            <h5 class="modal-title" id="sendGradesModalLabel" th:text="#{instructor_send_grades_banner}">Send Grades to Banner</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="selectBannerSection" th:text="#{instructor_banner_modal_label_section}">Select a section</label>
              <select class="form-control" name="sectionId" id="selectBannerSection">
                <option value="all" th:text="#{instructor_export_modal_all_sections}">All sections</option>
                <option th:each="section : ${sectionList}" th:value="${section.id}" th:text="${section.name}"></option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="canvas-btn rounded-btn" data-dismiss="modal" th:text="#{instructor_export_modal_close}">Close</button>
            <button type="submit" id="export-button" class="canvas-btn rounded-btn primary-btn">
              <span th:text="#{instructor_banner_modal_continue}">Continue</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

<div id="omitFromFinalGrade" class="d-none">
  <span class="col-icon fas fa-exclamation-circle" th:title="#{instructor_header_omit_final_grade}"></span>
</div>
<div id="assignmentMuted" class="d-none">
  <span class="col-icon fas fa-bell-slash" th:title="#{instructor_header_muted_assignment}"></span>
</div>

<!-- Header cell dropdown -->
<div id="header-cell-dropdown" class="d-none">
  <div class="header-cell-dropdown dropdown">
    <button class="btn btn-secondary dropdown-toggle assignment-dropdown" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
      <a class="dropdown-item dropdown-assignment-details" href="#" data-toggle="modal" data-target="#assignmentDetails" th:text="#{instructor_dropdown_assignment_details}">Assignment Details</a>
      <!--<a class="dropdown-item dropdown-speed-grader" target="_blank" href="#" th:text="#{instructor_dropdown_speed_grader}">Speed Grader</a>-->
      <a class="dropdown-item dropdown-send-message" href="#" data-toggle="modal" data-target="#sendMessage" th:text="#{instructor_dropdown_send_message}">Message students who...</a>
      <a class="dropdown-item dropdown-assignment-scale" target="_blank" href="#" data-toggle="modal" data-target="#assignmentScale"  th:text="#{instructor_dropdown_assignment_scale}">Change Assignment Scale</a>
      <a class="dropdown-item dropdown-minimum-score" href="#" th:text="#{instructor_dropdown_minimum_score}">Set Minimum Score for Empty Cells</a>
      <a class="dropdown-item dropdown-mute-assignment" href="#"></a>
    </div>
  </div>
</div>

<!-- Header group cell dropdown -->
<div id="header-group-cell-dropdown" class="d-none">
  <div class="header-cell-dropdown header-group-cell-dropdown dropdown">
    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
      <a class="dropdown-item dropdown-group-details" href="#" data-toggle="modal" data-target="#groupDetails" th:text="#{instructor_dropdown_group_details}">Group Details</a>
    </div>
  </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const LEFT_READ_ONLY_COLS = /*[[${LEFT_READ_ONLY_COLS}]]*/;
    const RIGHT_READ_ONLY_COLS = /*[[${RIGHT_READ_ONLY_COLS}]]*/;
    const TOTAL_COLUMNS = /*[[${TOTAL_COLUMNS}]]*/;
    const INVALID_VALUES_ARRAY = ['', '-', 'A+', 'A', 'A-','B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'F'];
    const FINAL_GRADE_VALID_VALUES = ['P', 'I', 'R', 'A'];
    const MIN_GRADE = 1;
    const MAX_GRADE = 7;
    const GRADE_NOT_AVAILABLE = '-';

    //const MSG_TYPE_NOT_SUBMITTED = 0;
    const MSG_TYPE_NOT_GRADED = 1;
    const MSG_TYPE_LESS_THAN = 2;
    const MSG_TYPE_MORE_THAN = 3;

    var groupWeightsAre100 = /*[[${!groupWeightsNot100}]]*/;
    var initialized = false;

    window.GbGradeTable = { _onReadyCallbacks: [] };
    var assignmentGroupArray = /*[[${assignmentGroupArray}]]*/;
    var sectionMap = /*[[${sectionMap}]]*/;
    var columns = /*[[${tableHeaderList}]]*/;
    var data = /*[[${studentRowList}]]*/;
    var cellSettings = /*[[${cellRowListSettings}]]*/;
    var messages = {
      instructor_import_modal_info: /*[[#{instructor_import_modal_info}]]*/,
      instructor_not_supported: /*[[#{instructor_not_supported}]]*/,
      instructor_replaced_grade: /*[[#{instructor_replaced_grade}]]*/,
      instructor_not_replaced_grade: /*[[#{instructor_not_replaced_grade}]]*/,
      instructor_assignment_not_assigned: /*[[#{instructor_assignment_not_assigned}]]*/,
      instructor_details_modal_title: /*[[#{instructor_details_modal_title}]]*/,
      instructor_details_modal_total: /*[[#{instructor_details_modal_total}]]*/,
      instructor_group_details_modal_title: /*[[#{instructor_group_details_modal_title}]]*/,
      instructor_grade_out_range: /*[[#{instructor_grade_out_range}]]*/,
      instructor_final_grade_out_range: /*[[#{instructor_final_grade_out_range}]]*/,
      instructor_no_points_possible: /*[[#{instructor_no_points_possible}]]*/,
      instructor_assignment_scale_modal_title: /*[[#{instructor_assignment_scale_modal_title}]]*/,
      instructor_dropdown_mute_assignment: /*[[#{instructor_dropdown_mute_assignment}]]*/,
      instructor_dropdown_unmute_assignment: /*[[#{instructor_dropdown_unmute_assignment}]]*/,
      instructor_send_message_modal_title: /*[[#{instructor_send_message_modal_title}]]*/,
      instructor_send_message_modal_subject_0: /*[[#{instructor_send_message_modal_subject_0}]]*/,
      instructor_send_message_modal_subject_1: /*[[#{instructor_send_message_modal_subject_1}]]*/,
      instructor_send_message_modal_subject_2: /*[[#{instructor_send_message_modal_subject_2}]]*/,
      instructor_send_message_modal_subject_3: /*[[#{instructor_send_message_modal_subject_3}]]*/,
      instructor_header_omit_final_grade: /*[[#{instructor_header_omit_final_grade}]]*/,
      instructor_header_muted_assignment: /*[[#{instructor_header_muted_assignment}]]*/,
      instructor_ignore_highest_grade: /*[[#{instructor_ignore_highest_grade}]]*/,
      instructor_ignore_lowest_grade: /*[[#{instructor_ignore_lowest_grade}]]*/,
      shared_ignored_assignments_message: /*[[#{shared_ignored_assignments_message}]]*/,
      instructor_audit_log_date: /*[[#{instructor_audit_log_date}]]*/,
      instructor_audit_log_student_name: /*[[#{instructor_audit_log_student_name}]]*/,
      instructor_audit_log_assignment: /*[[#{instructor_audit_log_assignment}]]*/,
      instructor_audit_log_old_grade: /*[[#{instructor_audit_log_old_grade}]]*/,
      instructor_audit_log_new_grade: /*[[#{instructor_audit_log_new_grade}]]*/,
      instructor_audit_log_instructor_name: /*[[#{instructor_audit_log_instructor_name}]]*/,
      instructor_datatables_info: /*[[#{instructor_datatables_info}]]*/,
      instructor_datatables_emptyTable: /*[[#{instructor_datatables_emptyTable}]]*/,
      instructor_datatables_next: /*[[#{instructor_datatables_next}]]*/,
      instructor_datatables_previous: /*[[#{instructor_datatables_previous}]]*/,
      instructor_datatables_sortAscending: /*[[#{instructor_datatables_sortAscending}]]*/,
      instructor_datatables_sortDescending: /*[[#{instructor_datatables_sortDescending}]]*/,
      instructor_dropdown_speed_grader: /*[[#{instructor_dropdown_speed_grader}]]*/
    };
    var container = $('#studentTable' + [[${courseId}]])[0];
    var studentFilter = document.getElementById('studentFilter');

    var isValidGrade = function isValidGrade(grade) {
      var floatValue = parseFloat(grade);
      if (floatValue !== NaN && floatValue >= MIN_GRADE && floatValue <= MAX_GRADE) {
        return true;
      } else {
        return false;
      }
    }

    var scrollTop     = $(window).scrollTop(),
        elementOffset = $('.studentTable').offset().top,
        distance      = (elementOffset - scrollTop);
    var handsontableHeight = window.innerHeight - distance;
    GbGradeTable.instance = new Handsontable(container, {
      data: data,
      colHeaders: columns,
      dropdownMenu: false,
      columnSorting: true,
      manualColumnMove: true,
      manualColumnResize: true,
      filters: true,
      autoRowSize: true,
      autoColSize: false,
      currentRowClassName: 'currentRow',
      currentColClassName: 'currentCol',
      multiSelect: false,
      copyPaste: false,
      persistentState: true,
      width: '100%',
      height: handsontableHeight,
      fixedColumnsLeft: LEFT_READ_ONLY_COLS-1,
      fixedColumnsRight: RIGHT_READ_ONLY_COLS,
      className: 'htCenter',
      modifyColWidth: function(width, col){
          // Max column width is the half of the screen less 20 pixels
          var maxWidth = window.innerWidth / 2 - 20;
          if(width > maxWidth) {
            return maxWidth
          }
      },
      colHeaders: function(col) {
          return columnRenderer(col);
      },
      cells: function(row, col, prop) {
          var properties = cellSettings[row+1][col];
          var prevRenderer = properties.renderer;
          if (properties === undefined) properties = [];

          properties.renderer = cellBlankRenderer;

          if (properties.gradeOutOfRange) {
            properties.renderer = cellSaveErrorRenderer;
          }

          if (properties.isZeroPoints) {
            properties.renderer = cellNoPointsRenderer;
          }

          if (properties.overwrittenGrade) {
            if (properties.gradedPreviously)
              properties.renderer = cellConvertedRatingRenderer;
            else
              properties.renderer = cellRatingRenderer;
          }

          if (col >= (TOTAL_COLUMNS - RIGHT_READ_ONLY_COLS) && (col + 1 != TOTAL_COLUMNS)) {
            properties.editor = false;
          }

          if (properties.isVisibleForUser !== undefined && !properties.isVisibleForUser) {
            properties.editor = false;
            properties.renderer = cellLockedRenderer;
          }

          if (properties.gradeTypeNotSupported) {
            properties.editor = false;
            properties.renderer = cellNotSupportedRenderer;
          }

          if (prevRenderer) {
            properties.renderer = prevRenderer;
          }

          if (col < LEFT_READ_ONLY_COLS) {
            properties.editor = false;
            if (properties.className)
              properties.className = properties.className + ' align-left';
            else
              properties.className = 'align-left';
          }

          return properties;
      },
      beforeColumnMove: function(columnsMoving, target) {
          //Ignore first columns when moving another column
          if (columnsMoving[0] < LEFT_READ_ONLY_COLS || target < LEFT_READ_ONLY_COLS) {
            return false;
          }
          //Ignore last columns when moving another column
          if (columnsMoving[0] >= (TOTAL_COLUMNS - RIGHT_READ_ONLY_COLS) || target > (TOTAL_COLUMNS - RIGHT_READ_ONLY_COLS)) {
            return false;
          }
          return true;
      },
      afterRender: function() {
          filterTable();
      },
      beforeChange: function(changes, source) {
          $(changes).each(function(idx, elem) {
            var physicalRow = GbGradeTable.instance.toPhysicalRow(elem[0]);
            var cellMeta = cellSettings[physicalRow+1][elem[1]];
            //If not editable, avoid the change
            if (cellMeta.editor !== undefined && !cellMeta.editor && changes[idx][3] === '') {
              changes[idx][3] = changes[idx][2];
              return;
            }
            var input = elem[3].replace(/,/g, '.');
            if (isValidGrade(input)) {
              var value = parseFloat(input);
              value = math.round(value, 1);
              if (Number.isInteger(value)) value = value + '.0';
              changes[idx][3] = value;
            }
          });
          return changes;
      },
      afterColumnSort: function() {
        $('.header-cell-dropdown.show').dropdown('toggle');
        $('body > .dropdown-menu.show').remove();
      },
      afterInit: function() {
        var _instance = this;
        var ajaxRequests = [];
        for (var i = 0; i < this.getData().length; i++) {
          var physicalRow = this.toPhysicalRow(i);
          var userId = cellSettings[physicalRow+1][0].userId;
          var sortedArray = Object.keys(assignmentGroupArray).map(function(groupId) {
            assignmentGroupArray[groupId].groupId = groupId;
            return assignmentGroupArray[groupId];
          });
          sortedArray = sortedArray.sort((a,b) => (a.assignmentGroupColIndex > b.assignmentGroupColIndex) ? 1 : ((b.assignmentGroupColIndex > a.assignmentGroupColIndex) ? -1 : 0));
          Object.keys(sortedArray).forEach(function(idx) {
            ajaxRequests.push(calcGroupGrade(sortedArray[idx].groupId, userId, i, false, _instance));
          });
          ajaxRequests.push(calcFinalGrade(userId, i, true, false, _instance));
          if (groupWeightsAre100) {
            ajaxRequests.push(calcFinalGrade(userId, i, false, false, _instance));
          } else {
            ajaxRequests.push(GRADE_NOT_AVAILABLE);
          }
        }
        Promise.all(ajaxRequests).then((arr) => {
          var newArr = [];
          while(arr.length) newArr.push(arr.splice(0, Object.keys(assignmentGroupArray).length + 2));
          this.populateFromArray(0, TOTAL_COLUMNS - RIGHT_READ_ONLY_COLS, newArr);
          var columnSorting = this.getPlugin('columnSorting');
          initialized = true;
          columnSorting.sort(columnSorting.getSortConfig()[0]);

          var daWidth = $('.studentTable > .handsontable.ht_master > .wtHolder > .wtHider').width();
          $('.div1').css('width', daWidth + 'px');
        });

        var daWidth = $('.studentTable > .handsontable.ht_master > .wtHolder > .wtHider').width();
        $('.div1').css('width', daWidth + 'px');

        if (_instance.getSettings().height > $('.handsontable.ht_master > .wtHolder > .wtHider')[0].offsetHeight) {
          _instance.updateSettings({height:$('.handsontable.ht_master > .wtHolder > .wtHider')[0].offsetHeight + 17})
        }
      },
      afterChange: function(changes, source) {
          var _instance = this;
          if (changes) {
            for (var i=0; i<changes.length; i++) {
              var change = changes[i];
              var row = change[0];
              var col = change[1];
              var $cell = $(GbGradeTable.instance.getCell(row, col));
              var visualRow = GbGradeTable.instance.toVisualRow(row);
              var visualCol = GbGradeTable.instance.toVisualColumn(col);
              var physicalRow = GbGradeTable.instance.toPhysicalRow(row);
              var physicalCol = GbGradeTable.instance.toPhysicalColumn(col);
              var cellMeta = GbGradeTable.instance.getCellMeta(row, visualCol);
              var oldScore = cellMeta.score;
              var newScore = change[3];
              if (oldScore === undefined) {
                oldScore = change[2];
              }

              if (col < (TOTAL_COLUMNS - RIGHT_READ_ONLY_COLS)) {
                console.debug('Assignment ' + cellMeta.assignmentId + ' changed to ' + newScore + ' for user '+cellMeta.userId);
                var studentGrade = {};
                studentGrade['assignmentId'] = cellMeta.assignmentId;
                studentGrade['userId'] = cellMeta.userId;
                studentGrade['grade'] = newScore;
                studentGrade['oldGrade'] = oldScore;

                if (oldScore+'' !== newScore+'') {
                  $.ajax({
                    url: /*[[@{/postGrade}]]*/,
                    type: 'POST',
                    data: JSON.stringify(studentGrade),
                    dataType: 'json',
                    custom: {
                      row: row,
                      col: col,
                      visualRow: visualRow,
                      physicalRow: physicalRow,
                      physicalCol: physicalCol
                    },
                    contentType: 'application/json; charset=utf-8'

                  }).done(function() {
                    console.debug('The grade has been saved successfully.');
                    var settings = cellSettings[this.custom.physicalRow+1][this.custom.col];
                    settings.renderer = cellSaveSuccessRenderer;
                    settings.score = newScore;
                    var groupId = settings.assignmentGroupId;
                    var userId = settings.userId;
                    if (!settings.omitFromFinalGrade && !settings.assignmentIsMuted) {
                      calcGroupGrade(groupId, userId, this.custom.physicalRow, true, _instance);
                      calcFinalGrade(userId, this.custom.physicalRow, true, true, _instance);
                      if (groupWeightsAre100) {
                        calcFinalGrade(userId, this.custom.physicalRow, false, true, _instance);
                      }
                    }

                  }).fail(function() {
                    console.debug('The grade has not been saved.');
                    cellSettings[this.custom.physicalRow+1][this.custom.col].renderer = cellSaveErrorRenderer;

                  }).always(function(){
                    console.debug('After posting the grades to the tool.');
                    GbGradeTable.instance.render();
                  });
                }
              } else if (col + 1 == TOTAL_COLUMNS) {
                // Override final grade
                var studentGrade = {};
                studentGrade['courseId'] = [[${courseId}]];
                studentGrade['userId'] = cellMeta.userId;
                studentGrade['grade'] = newScore;
                studentGrade['oldGrade'] = oldScore;

                if (oldScore+'' !== newScore+'' && newScore != '-' && initialized) {
                  console.debug('Final grade changed to ' + newScore + ' for user '+cellMeta.userId);

                  $.ajax({
                    url: /*[[@{/postFinalGrade}]]*/,
                    type: 'POST',
                    data: JSON.stringify(studentGrade),
                    dataType: 'json',
                    custom: {
                      row: row,
                      col: col,
                      visualRow: visualRow,
                      physicalRow: physicalRow,
                      physicalCol: physicalCol
                    },
                    contentType: 'application/json; charset=utf-8'

                  }).done(function() {
                    console.debug('The grade has been saved successfully.');
                    var settings = cellSettings[this.custom.physicalRow+1][this.custom.col];
                    settings.renderer = cellSaveSuccessRenderer;
                    settings.score = newScore;

                  }).fail(function() {
                    console.debug('The grade has not been saved.');
                    var prevRenderer = cellSettings[this.custom.physicalRow+1][this.custom.col].renderer;
                    if (prevRenderer === cellBlankRenderer) {
                      cellSettings[this.custom.physicalRow+1][this.custom.col].renderer = cellGroupGradeRenderer;
                    } else {
                      cellSettings[this.custom.physicalRow+1][this.custom.col].renderer = cellFinalGradeSaveErrorRenderer;
                    }

                  }).always(function(){
                    console.debug('After posting the grades to the tool.');
                    GbGradeTable.instance.render();
                  });
                }
              }
            }
          }
        }
    });

    /**** RENDERERS ****/
    function columnRenderer(col) {
      var html = '';
      var properties = cellSettings[0][col];
      if (properties === undefined) properties = [];
      if (properties.omitFromFinalGrade) html += document.getElementById('omitFromFinalGrade').firstElementChild.outerHTML;
      if (properties.assignmentIsMuted) html += document.getElementById('assignmentMuted').firstElementChild.outerHTML;
      html += '<span title="' + columns[col] + '">' + columns[col] + '</span>';
      if (col >= LEFT_READ_ONLY_COLS && col < (TOTAL_COLUMNS - RIGHT_READ_ONLY_COLS)) {
        var toClone = document.getElementById('header-cell-dropdown').firstElementChild.outerHTML;
        toClone = toClone.replace('class="dropdown-menu"', 'class="dropdown-menu" data-col="' + col + '"');
        html += toClone;
      }
      if ((col >= (TOTAL_COLUMNS - RIGHT_READ_ONLY_COLS)) && (col < (TOTAL_COLUMNS - 2))) {
        var toClone = document.getElementById('header-group-cell-dropdown').firstElementChild.outerHTML;
        toClone = toClone.replace('class="dropdown-menu"', 'class="dropdown-menu" data-col="' + col + '"');
        html += toClone;
      }
      return html;
    }

    function cellBlankRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      var html = '';
      // Set title to first 3 columns (RUT, Student Name and Section)
      if (col <= 2) {
        html += '<div title="' + td.innerHTML + '">';
      } else {
        html += '<div>';
      }
      html += td.innerHTML;
      if (cellProperties.speedGraderUrl != undefined) {
        html += '<a title="' + messages.instructor_dropdown_speed_grader + '" class="fas fa-external-link-alt speed-grader" aria-hidden="true" href="' + cellProperties.speedGraderUrl + '" + target="_blank"></a>';
      }
      html += '</div>';
      $(td).html(html);
    }

    function cellGroupGradeRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      var physicalRow = GbGradeTable.instance.toPhysicalRow(row);
      var physicalCol = GbGradeTable.instance.toPhysicalColumn(col);
      var cellMeta = cellSettings[physicalRow+1][physicalCol];

      var html = '<div>';
      html += td.innerHTML;
      var createQtip = false;
      if ((cellMeta.omittedAssignments && cellMeta.omittedAssignments.length > 0) ||
          (cellMeta.mutedAssignments && cellMeta.mutedAssignments.length > 0) ||
          (cellMeta.dropHighestAssignments && cellMeta.dropHighestAssignments.length > 0) ||
          (cellMeta.dropLowestAssignments && cellMeta.dropLowestAssignments.length > 0)) {
        html += '<span class="qtip-info fa fa-info-circle ml-1" aria-hidden="true"></span>';
        html += '<div class="qtip-content d-none">';
        html +=   '<p class="mb-2">' + messages.shared_ignored_assignments_message + '</p>';
        html +=   '<table class="table table-sm mb-0"><tbody>';
        $(cellMeta.omittedAssignments).each(function(idx, obj) {
          html +=   '<tr title="' + messages.instructor_header_omit_final_grade + '"><td>' + obj.name + '</td><td class="w-content"><span class="qtip-info-icon fas fa-exclamation-circle" aria-hidden="true"></span></td></tr>';
        });
        $(cellMeta.mutedAssignments).each(function(idx, obj) {
          html +=   '<tr title="' + messages.instructor_header_muted_assignment + '"><td>' + obj.name + '</td><td class="w-content"><span class="qtip-info-icon fas fa-bell-slash" aria-hidden="true"></span></td></tr>';
        });
        $(cellMeta.dropHighestAssignments).each(function(idx, obj) {
          html +=   '<tr title="' + messages.instructor_ignore_highest_grade + '"><td>' + obj.name + '</td><td class="w-content"><span class="qtip-info-icon fas fa-arrow-up" aria-hidden="true"></span></td></tr>';
        });
        $(cellMeta.dropLowestAssignments).each(function(idx, obj) {
          html +=   '<tr title="' + messages.instructor_ignore_lowest_grade + '"><td>' + obj.name + '</td><td class="w-content"><span class="qtip-info-icon fas fa-arrow-down" aria-hidden="true"></span></td></tr>';
        });
        html +=   '</tbody></table';
        html += '</div>';
        createQtip = true;
      }
      html += '</div>';
      $(td).html(html);

      if (createQtip){
        $(td).addClass('cursor-pointer');
        $(td).find('> div').qtip({
          position: {
            my : 'top center',
            at: 'bottom center',
            method: 'none'
          },
          show: {
            event: 'click',
            delay: 0,
          },
          style: {
            classes: 'qtip-content-info qtip-shadow qtip-light'
          },
          hide: {
            event: 'click',
          },
          content: $(td).find('.qtip-content').clone().removeClass('d-none').html(),
          events: {
            show: function(event, api) {
              $('.qtip:visible').qtip('hide');
            }
          }
        });
      }
    }

    function cellRatingRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      var html = '<div class="gb-save-info" title="' + messages.instructor_not_replaced_grade + '">' + td.innerHTML;
      if (cellProperties.speedGraderUrl != undefined) {
        html += '<a title="' + messages.instructor_dropdown_speed_grader + '" class="fas fa-external-link-alt speed-grader" aria-hidden="true" href="' + cellProperties.speedGraderUrl + '" + target="_blank"></a>';
      }
      html += '</div>';
      $(td).html(html);
    }

    function cellConvertedRatingRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      var html = '<div class="gb-save-info" title="' + messages.instructor_replaced_grade + '">' + td.innerHTML;
      if (cellProperties.speedGraderUrl != undefined) {
        html += '<a title="' + messages.instructor_dropdown_speed_grader + '" class="fas fa-external-link-alt speed-grader" aria-hidden="true" href="' + cellProperties.speedGraderUrl + '" + target="_blank"></a>';
      }
      html += '</div>';
      $(td).html(html);
    }

    function cellNotSupportedRenderer(instance, td, row, col, prop, value, cellProperties) {
        Handsontable.renderers.TextRenderer.apply(this, arguments);
        $(td).html('<div class="gb-cell-disabled" title="' + messages.instructor_not_supported + '">' + td.innerHTML + '</div>');
    }

    function cellNoPointsRenderer(instance, td, row, col, prop, value, cellProperties) {
        Handsontable.renderers.TextRenderer.apply(this, arguments);
        $(td).html('<div class="gb-not-supported" title="' + messages.instructor_no_points_possible + '">' + td.innerHTML + '</div>');
    }

    var timeout;
    function cellSaveSuccessRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      var value = td.innerHTML;
      //if (Number.isInteger(value)) GbGradeTable.instance.setDataAtCell(row, col, value);
      $(td).html('<div class="gb-save-success">' + value + '</div>');
      var physicalRow = GbGradeTable.instance.toPhysicalRow(row);
      var physicalCol = GbGradeTable.instance.toPhysicalColumn(col);
      clearTimeout(timeout);
      var timeout = setTimeout(function() {
        var gradedPreviously = cellSettings[physicalRow+1][physicalCol].gradedPreviously;
        if (gradedPreviously)
          cellSettings[physicalRow+1][physicalCol].renderer = cellConvertedRatingRenderer;
        else
          cellSettings[physicalRow+1][physicalCol].renderer = cellRatingRenderer;
        var hasClassSuccess = $(td).find('.gb-save-success');
        if (hasClassSuccess.length > 0) {
          hasClassSuccess.removeClass('gb-save-success').addClass('gb-save-info');
          if (gradedPreviously) hasClassSuccess.attr('title', messages.instructor_replaced_grade);
        }
      }, 3000);
    }

    function cellSaveErrorRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      var html = '<div class="gb-save-error" title="' + messages.instructor_grade_out_range + '">' + td.innerHTML;
      if (cellProperties.speedGraderUrl != undefined) {
        html += '<a title="' + messages.instructor_dropdown_speed_grader + '" class="fas fa-external-link-alt speed-grader" aria-hidden="true" href="' + cellProperties.speedGraderUrl + '" + target="_blank"></a>';
      }
      html += '</div>';
      $(td).html(html);
    }

    function cellFinalGradeSaveErrorRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      var html = '<div class="gb-save-error" title="' + messages.instructor_final_grade_out_range + '">' + td.innerHTML;
      if (cellProperties.speedGraderUrl != undefined) {
        html += '<a title="' + messages.instructor_dropdown_speed_grader + '" class="fas fa-external-link-alt speed-grader" aria-hidden="true" href="' + cellProperties.speedGraderUrl + '" + target="_blank"></a>';
      }
      html += '</div>';
      $(td).html(html);
    }

    function cellLoadingRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      $(td).html('<div class="spinner"></div>');
    }

    function cellLockedRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      $(td).html('<div class="gb-cell-disabled" title="' + messages.instructor_assignment_not_assigned + '">' + td.innerHTML + '</div>');
    }
    /**** END OF RENDERERS ****/

    // Filter table
    function filterTable() {
      if (GbGradeTable.instance === undefined) return false;
      $('.ht_master.handsontable .htCore tbody tr, .ht_clone_left.handsontable .htCore tbody tr').removeClass('hidden');
      $(GbGradeTable.instance.getData()).each(function(index, elem) {
        var idValue = elem[0].toLowerCase();
        var nameValue = elem[1].toLowerCase();
        var sectionValue = elem[2].toLowerCase();
        var inputValue = studentFilter.value.toLowerCase();
        if (idValue.indexOf(inputValue) == -1 && nameValue.indexOf(inputValue) == -1 && sectionValue.indexOf(inputValue) == -1) {
          $($('.ht_master.handsontable > .wtHolder .htCore > tbody > tr')[index]).addClass('hidden');
          $($('.ht_clone_left.handsontable .htCore tbody tr')[index]).addClass('hidden');
        }
      });
    }
    var debounceFilterTable = Handsontable.helper.debounce(filterTable, 200);
    studentFilter.addEventListener('keydown', function(event) {
      debounceFilterTable();
    });

    /**** IMPORT AND EXPORT ****/
    // Export data to CSV
    $('#export-button').click(function() {
      $('#export-button').prop('disabled', true);
      $('#export-button').addClass('spinner');
      $.ajax({
        url: /*[[@{/export_csv}]]*/,
        method: 'GET',
        data: {
          'sectionId': $('#exportCsvSection').val()
        },
        xhrFields: {
          responseType: 'blob'
        },
        success: function (data) {
          var a = document.createElement('a');
          var url = window.URL.createObjectURL(data);
          a.href = url;
          a.download = /*[[${exportFileName}]]*/;
          document.body.append(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
          $('#export-button').prop('disabled', false);
          $('#export-button').removeClass('spinner');
        }
      });
    });

    // Import CSV
    Dropzone.options.fileDropzone = {
      autoProcessQueue: false,
      maxFiles: 1,
      dictDefaultMessage: messages.instructor_import_modal_info,
      acceptedMimeTypes: '.csv',
      init: function () {
        var myDropzone = this;
        $('#submitCsv').click(function() {
          myDropzone.processQueue();
          $('#submitCsv').prop('disabled', true);
          $('#submitCsv').addClass('spinner');
        });
        $('#importCsv').on('hidden.bs.modal', function (e) {
          myDropzone.removeAllFiles(true);
          $('#submitCsv').prop('disabled', true);
        })
        myDropzone.on('addedfile', function(file) {
          $('#submitCsv').prop('disabled', false);
        });
        myDropzone.on('success', function(file, errors) {
          window.location = [[@{/}]] + '?errors=' + errors;
        });
        myDropzone.on('error', function() {
          myDropzone.removeAllFiles(true);
          $('#import-error').removeClass('d-none');
          $('#submitCsv').removeClass('spinner');
          $('#submitCsv').prop('disabled', true);
        });
      }
    };
    $("#file-dropzone").dropzone();
    /**** END OF IMPORT AND EXPORT ****/

    /**** DROPDOWNS ****/
    // Assignment header dropdowns creation
    $('body').on('show.bs.dropdown', '.dropdown', function() {
      $('body').append($(this).find('.dropdown-menu').css({
        position: 'absolute',
        left: $(this).offset().left,
        top: $(this).offset().top
      }).detach());
    });

    // Close dropdowns on scroll
    $('.wtHolder').scroll(function() {
      $('.header-cell-dropdown.show').dropdown('toggle');
      $('body > .dropdown-menu.show').remove();
      $('.qtip:visible').qtip('hide');
    });

    // Populate assignment details modal 
    $('body').on('click', '.dropdown-assignment-details', function(e) {
      e.preventDefault();
      var col = $(this).parent().data('col');
      var headerSettings = cellSettings[0][col];
      var visualCol = GbGradeTable.instance.toVisualColumn(col);
      var meanValue = GRADE_NOT_AVAILABLE;
      var maxValue = GRADE_NOT_AVAILABLE;
      var minValue = GRADE_NOT_AVAILABLE;
      var totalGraded = 0;

      try {
        var updatedColData = _.difference(GbGradeTable.instance.getDataAtCol(visualCol), INVALID_VALUES_ARRAY);
        var meanValue = math.round(math.mean(updatedColData), 1);
        var maxValue = math.max(updatedColData);
        var minValue = math.min(updatedColData);
        totalGraded = updatedColData.length;
        if (Number.isInteger(meanValue)) meanValue = meanValue + '.0';
      } catch(error) {
        //TODO: Set the mean value to invalid when the data is not valid
      }

      $('#assignmentDetails .modal-title').text(messages.instructor_details_modal_title.replace('{0}', headerSettings.assignmentName));
      $('#assignmentDetails #meanValue').text(meanValue);
      $('#assignmentDetails #minValue').text(minValue);
      $('#assignmentDetails #maxValue').text(maxValue);
      $('#assignmentDetails #totalGraded').text(messages.instructor_details_modal_total.replace('{0}', totalGraded));
    });

    // Put speed grader url
    $('body').on('click', '.dropdown-speed-grader', function() {
      var col = $(this).parent().data('col');
      var headerSettings = cellSettings[0][col];
      $(this).attr('href', headerSettings.speedGraderUrl)
    });

    // Populate send message modal
    $('body').on('click', '.dropdown-send-message', function(e) {
      e.preventDefault();
      var col = $(this).parent().data('col');
      var headerSettings = cellSettings[0][col];
      var visualCol = GbGradeTable.instance.toVisualColumn(col);
      $('#sendMessage .modal-title').text(messages.instructor_send_message_modal_title.replace('{0}', headerSettings.assignmentName));
      $('#send-message-assignment-name').val(headerSettings.assignmentName);
      $('#send-message-assignment-id').val(headerSettings.id);
      $('#sendMessageSubject').val(messages.instructor_send_message_modal_subject_0.replace('{0}', headerSettings.assignmentName));
      $('#selected-column').val(visualCol);
      updateSendMessageUsers();
    });

    $('#messageTypes').change(function() {
      var value = parseInt($(this).val());
      var assignmentName = $('#send-message-assignment-name').val();
      var cutoff_score = Number($('#cutoff_score').val().replace(',','.'));
      if (isNaN(cutoff_score)) cutoff_score = 0;
      switch(value) {
        case MSG_TYPE_NOT_GRADED:
          $('#sendMessageSubject').val(messages.instructor_send_message_modal_subject_1.replace('{0}', assignmentName));
          $('.cutoff_score_container').addClass('d-none');
          break;
        case MSG_TYPE_LESS_THAN:
          $('#sendMessageSubject').val(messages.instructor_send_message_modal_subject_2.replace('{0}', cutoff_score)
                                                                                       .replace('{1}', assignmentName));
          $('.cutoff_score_container').removeClass('d-none');
          break;
        case MSG_TYPE_MORE_THAN:
          $('#sendMessageSubject').val(messages.instructor_send_message_modal_subject_3.replace('{0}', cutoff_score)
                                                                                       .replace('{1}', assignmentName));
          $('.cutoff_score_container').removeClass('d-none');
          break;
      }
      validateSendMessageForm();
      updateSendMessageUsers();
    });

    $('#cutoff_score').change(function() {
      var value = Number($(this).val().replace(',', '.'));
      var assignmentName = $('#send-message-assignment-name').val();
      if (isNaN(value)) {
        $(this).val('');
        value = 0;
      }
      var messageTypesValue = parseInt($('#messageTypes').val());
      switch(messageTypesValue) {
        case MSG_TYPE_LESS_THAN:
          $('#sendMessageSubject').val(messages.instructor_send_message_modal_subject_2.replace('{0}', value)
                                                                                       .replace('{1}', assignmentName));
          $('.cutoff_score_container').removeClass('d-none');
          break;
        case MSG_TYPE_MORE_THAN:
          $('#sendMessageSubject').val(messages.instructor_send_message_modal_subject_3.replace('{0}', value)
                                                                                       .replace('{1}', assignmentName));
          $('.cutoff_score_container').removeClass('d-none');
          break;
      }
      validateSendMessageForm();
    });

    $('#cutoff_score, #sendMessageSubject, #sendMessageTextarea').on('keypress keydown keyup', function() {
      validateSendMessageForm();
      updateSendMessageUsers()
    });

    $('#sendMessage').on('hidden.bs.modal', function (e) {
      $('#messageTypes').val(1).change();
      $('#cutoff_score').val('');
      $('#sendMessageTextarea').val('');
      $('#send-message-button').prop('disabled', true);
    });

    function validateSendMessageForm() {
      var cutoff_score = $('#cutoff_score').val();
      var sendMessageSubject = $('#sendMessageSubject').val();
      var sendMessageTextarea = $('#sendMessageTextarea').val();
      var messageTypesValue = parseInt($('#messageTypes').val());
      var visualCol = $('#selected-column').val();
      var dataAtCol = GbGradeTable.instance.getDataAtCol(visualCol);
      var userIds = [];
      var usernames = [];
      $(dataAtCol).each(function(idx, val) {
        var cellMeta = GbGradeTable.instance.getCellMeta(idx, visualCol);
        if (cellMeta.isVisibleForUser) {
          switch(messageTypesValue) {
            case MSG_TYPE_NOT_GRADED:
              if (val == GRADE_NOT_AVAILABLE) {
                userIds.push(cellMeta.userId);
              }
              break;
            case MSG_TYPE_LESS_THAN:
              if (!isNaN(cutoff_score) && $('#cutoff_score').val() != '' && parseFloat(val) < cutoff_score) {
                userIds.push(cellMeta.userId);
              }
              break;
            case MSG_TYPE_MORE_THAN:
              if (!isNaN(cutoff_score) && $('#cutoff_score').val() != '' && parseFloat(val) > cutoff_score) {
                userIds.push(cellMeta.userId);
              }
              break;
          }
        }
      });
      if (userIds.length > 0 && sendMessageSubject != '' && sendMessageTextarea != '' &&
        (((cutoff_score != '' && (messageTypesValue == MSG_TYPE_LESS_THAN || messageTypesValue == MSG_TYPE_MORE_THAN))) ||
        (messageTypesValue == MSG_TYPE_NOT_GRADED))) {
        $('#send-message-button').prop('disabled', false);
      } else {
        $('#send-message-button').prop('disabled', true);
      }
    }

    function updateSendMessageUsers() {
      var visualCol = $('#selected-column').val();
      var dataAtCol = GbGradeTable.instance.getDataAtCol(visualCol);
      var messageTypesValue = parseInt($('#messageTypes').val());
      var cutoff_score = Number($('#cutoff_score').val().replace(',','.'));
      var userIds = [];
      var usernames = [];
      $(dataAtCol).each(function(idx, val) {
        var cellMeta = GbGradeTable.instance.getCellMeta(idx, visualCol);
        if (cellMeta.isVisibleForUser) {
          switch(messageTypesValue) {
            case MSG_TYPE_NOT_GRADED:
              if (val == GRADE_NOT_AVAILABLE) {
                userIds.push(cellMeta.userId);
                usernames.push(cellMeta.sortableName);
              }
              break;
            case MSG_TYPE_LESS_THAN:
              if (!isNaN(cutoff_score) && $('#cutoff_score').val() != '' && parseFloat(val) < cutoff_score) {
                userIds.push(cellMeta.userId);
                usernames.push(cellMeta.sortableName);
              }
              break;
            case MSG_TYPE_MORE_THAN:
              if (!isNaN(cutoff_score) && $('#cutoff_score').val() != '' && parseFloat(val) > cutoff_score) {
                userIds.push(cellMeta.userId);
                usernames.push(cellMeta.sortableName);
              }
              break;
          }
        }
      });
      $('#send-message-users').empty();
      $('#send-message-users').hide();
      if(usernames.length > 0) {
        $(usernames).each(function(idx, val) {
          $('#send-message-users').append('<li class="list-group-item">' + val + '</li>');
        });
        $('#send-message-users').show();
      }
      $('#send-message-user-ids').val(userIds);
    }

    $('#send-message-button').click(function() {
      $(this).addClass('spinner').prop('disabled', true);
      $.ajax({
        url: /*[[@{/sendMessageToUsers}]]*/,
        data: '{"userIds": [' + $('#send-message-user-ids').val() + '], "sendMessageSubject": "' + $("#sendMessageSubject").val() + '", "sendMessageTextarea": "' + $("#sendMessageTextarea").val() + '"}',
        type: 'POST',
        contentType: 'application/json; charset=utf-8'

      }).done(function(success) {
        window.location = [[@{/}]];
      });
    });

    // Populate assignment conversion scale modal 
    $('body').on('click', '.dropdown-assignment-scale', function(e) {
      e.preventDefault();
      var col = $(this).parent().data('col');
      var headerSettings = cellSettings[0][col];
      var assignmentConversionScale = cellSettings[1][col].assignmentConversionScale;
      $('#assignmentScale .modal-title').text(messages.instructor_assignment_scale_modal_title.replace('{0}', headerSettings.assignmentName));
      $('#assignmentConversionScale').val(assignmentConversionScale);
      $('#save-assignment-scale-button').off('click').click(function() {
        $('#save-assignment-scale-button').prop('disabled', true);
        $('#save-assignment-scale-button').addClass('spinner');
        $.ajax({
          url: [[@{/saveAssignmentConversionScale}]] + '?assignmentId=' + headerSettings.assignmentId + '&newConversionScale=' + $('#assignmentConversionScale').val(),
          type: 'POST',
          contentType: 'text/plain; charset=utf-8'
        }).done(function (data) {
          window.location = [[@{/}]];
        });
      });
    });

    // Set minimum possible score to all col cells
    $('body').on('click', '.dropdown-minimum-score', function(e) {
      e.preventDefault();
      $('body > .dropdown-menu.show').remove();
      var col = $(this).parent().data('col');
      var visualCol = GbGradeTable.instance.toVisualColumn(col);
      var newArr = [];
      var columnData = GbGradeTable.instance.getDataAtCol(visualCol);
      $(columnData).each(function(idx, cellValue) {
        var cellProperties = cellSettings[idx+1][col];
        if ((cellValue === GRADE_NOT_AVAILABLE || cellValue === '') && cellProperties.isVisibleForUser && !cellProperties.gradeTypeNotSupported) columnData[idx] = MIN_GRADE + '';
      });
      while(columnData.length) newArr.push(columnData.splice(0, 1));
      GbGradeTable.instance.populateFromArray(0, visualCol, newArr);
    });

    // Populate group details modal 
    $('body').on('click', '.dropdown-group-details', function(e) {
      e.preventDefault();
      var col = $(this).parent().data('col') - (TOTAL_COLUMNS - RIGHT_READ_ONLY_COLS);
      var headerSettings = Object.values(assignmentGroupArray)[col];
      var visualCol = $(this).parent().data('col');
      var meanValue = GRADE_NOT_AVAILABLE;
      var maxValue = GRADE_NOT_AVAILABLE;
      var minValue = GRADE_NOT_AVAILABLE;
      var totalGraded = 0;

      try {
        var updatedColData = _.difference(GbGradeTable.instance.getDataAtCol(visualCol), INVALID_VALUES_ARRAY);
        var meanValue = math.round(math.mean(updatedColData), 1);
        var maxValue = math.max(updatedColData);
        var minValue = math.min(updatedColData);
        totalGraded = updatedColData.length;
        if (Number.isInteger(meanValue)) meanValue = meanValue + '.0';
      } catch(error) {
        //TODO: Set the mean value to invalid when the data is not valid
      }

      $('#groupDetails .modal-title').text(messages.instructor_group_details_modal_title.replace('{0}', headerSettings.assignmentGroupName));
      $('#groupDetails #meanValue').text(meanValue);
      $('#groupDetails #minValue').text(minValue);
      $('#groupDetails #maxValue').text(maxValue);
      $('#groupDetails #totalGraded').text(messages.instructor_details_modal_total.replace('{0}', totalGraded));
    });

    // Mute assignment
    $('body').on('click', '.dropdown-mute-assignment', function(e) {
      e.preventDefault();
      $('body > .dropdown-menu.show').remove();
      var col = $(this).parent().data('col');
      var headerSettings = cellSettings[0][col];
      $.ajax({
        url: [[@{/saveAssignmentMuted}]] + '?assignmentId=' + headerSettings.assignmentId + '&muted=' + !headerSettings.assignmentIsMuted,
        type: 'POST',
        contentType: 'text/plain; charset=utf-8'
      }).done(function (data) {
        window.location = [[@{/}]];
      });
    });
    $('body').on('click', '.assignment-dropdown', function() {
      var col = $(this).next().data('col');
      var headerSettings = cellSettings[0][col];
      if (headerSettings.assignmentIsMuted)
        $('.dropdown-menu[data-col=' + col + '] .dropdown-mute-assignment').text(messages.instructor_dropdown_unmute_assignment);
      else
        $('.dropdown-menu[data-col=' + col + '] .dropdown-mute-assignment').text(messages.instructor_dropdown_mute_assignment);
    });
    /**** END OF DROPDOWNS ****/

    /**** GROUP AND FINAL GRADES ****/
    function calcGroupGrade(groupId, userId, row, renderCell, _instance) {
      return new Promise((resolve, reject) => {
        var assignmentGroupColIndex = assignmentGroupArray[groupId].assignmentGroupColIndex;
        var realCol = TOTAL_COLUMNS-RIGHT_READ_ONLY_COLS+assignmentGroupColIndex;
        var realRow = _instance.toVisualRow(row) + 1;
        cellSettings[row+1][realCol].renderer = cellLoadingRenderer;

        $.ajax({
          url: [[@{/getStudentGroupGrade}]] + '?groupId=' + groupId + '&studentId=' + userId,
          type: 'POST',
          contentType: 'text/plain; charset=utf-8'

        }).done(function(response) {
          var assignmentGroupColIndex = assignmentGroupArray[groupId].assignmentGroupColIndex;
          var realCol = TOTAL_COLUMNS-RIGHT_READ_ONLY_COLS+assignmentGroupColIndex;
          var realRow = _instance.toVisualRow(row);
          var physicalRow = _instance.toPhysicalRow(row);
          var isPhysical = true;
          var daRow = physicalRow+1;
          if (cellSettings[row+1][realCol].userId == userId) {
            isPhyshical = false;
            daRow = row+1;
          }
          cellSettings[daRow][realCol].omittedAssignments = response.omittedAssignments;
          cellSettings[daRow][realCol].mutedAssignments = response.mutedAssignments;
          cellSettings[daRow][realCol].dropHighestAssignments = response.dropHighestAssignments;
          cellSettings[daRow][realCol].dropLowestAssignments = response.dropLowestAssignments;
          cellSettings[daRow][realCol].renderer = cellGroupGradeRenderer;
          if (renderCell) {
            _instance.setDataAtCell(realRow, realCol, response.grade)
          } else {
            // If cell is visible, avoid method 'setDataAtCell' to avoid table re-render on each cell value change
            var cell = _instance.getCell(daRow, realCol);
            if (cell !== undefined) $(cell).find('.spinner').text(response.grade).removeClass('spinner');
          }
          resolve(response.grade);
        });
      });
    }

    function calcFinalGrade(userId, row, isCurrentGrade, renderCell, _instance) {
      return new Promise((resolve, reject) => {
        var realCol = TOTAL_COLUMNS - 1;
        if (isCurrentGrade) realCol--;
        var realRow = _instance.toVisualRow(row);
        cellSettings[row+1][realCol].renderer = cellLoadingRenderer;

        $.ajax({
          url: [[@{/getStudentFinalGrade}]] + '?studentId=' + userId + '&isCurrentGrade=' + isCurrentGrade,
          type: 'POST',
          contentType: 'text/plain; charset=utf-8'

        }).done(function(response) {
          var realCol = TOTAL_COLUMNS - 1;
          if (isCurrentGrade) realCol--;
          var realRow = _instance.toVisualRow(row);
          var physicalRow = _instance.toPhysicalRow(row);
          var isPhysical = true;
          var daRow = physicalRow+1;
          if (cellSettings[row+1][realCol].userId == userId) {
            isPhyshical = false;
            daRow = row+1;
          }
          cellSettings[daRow][realCol].omittedAssignments = response.omittedAssignments;
          cellSettings[daRow][realCol].mutedAssignments = response.mutedAssignments;
          cellSettings[daRow][realCol].dropHighestAssignments = response.dropHighestAssignments;
          cellSettings[daRow][realCol].dropLowestAssignments = response.dropLowestAssignments;
          cellSettings[daRow][realCol].renderer = cellGroupGradeRenderer;
          if (!isCurrentGrade && FINAL_GRADE_VALID_VALUES.includes(response.grade)) {
            cellSettings[daRow][realCol].renderer = cellSaveSuccessRenderer;
          }
          if (renderCell) {
            _instance.setDataAtCell(realRow, realCol, response.grade);
            if (!isCurrentGrade) {
              cellSettings[daRow][realCol].renderer = cellBlankRenderer;
            }

          } else {
            // If cell is visible, avoid method 'setDataAtCell' to avoid table re-render on each cell value change
            var cell = _instance.getCell(daRow, realCol);
            if (cell !== undefined) $(cell).find('.spinner').text(response.grade).removeClass('spinner');
          }
          resolve(response.grade);
        });
      });
    }
    /**** END OF GROUP AND FINAL GRADES ****/

    /**** SELECT THE WHOLE TEXTAREA ON CELL EDIT ****/
    $('body').on('select', '.handsontableInput', function() {
      this.select();
    });
    /**** END OF SELECT THE WHOLE TEXTAREA ON CELL EDIT ****/

    /**** CHANGE CONVERSION SCALE **/
    $('#conversionScaleSelector').change(function() {
        var newConversionScale = this.value;
        console.debug('Setting course conversion scale to ' + newConversionScale);
        $.ajax({
            url: [[@{/saveCourseConversionScale}]]  + '?newConversionScale=' + newConversionScale,
            type: 'POST',
            contentType: 'text/plain; charset=utf-8'
        }).done(function() {
            console.debug('Conversion scale saved successfully.');
            document.location.reload();
        });
    });
    /**** END OF CHANGE CONVERSION SCALE **/

    /**** LOAD COURSE GRADE EVENTS ****/
    jQuery.extend(jQuery.fn.dataTableExt.oSort, {
      "hiddenValue-asc": function (a, b) {
        a = $(a).find(".hiddenValue").text();
        b = $(b).find(".hiddenValue").text();
        return a.localeCompare(b);
      },
      "hiddenValue-desc": function (a, b) {
        a = $(a).find(".hiddenValue").text();
        b = $(b).find(".hiddenValue").text();
        return b.localeCompare(a);
      }
    });
    var search = /*[[#{instructor_datatables_records_search}]]*/ 'search';
    var lengthMenu = /*[[#{instructor_datatables_records_lengthMenu}]]*/ 'lengthMenu';
    var zeroRecords = /*[[#{instructor_datatables_records_zeroRecords}]]*/ 'zeroRecords';
    var info = /*[[#{instructor_datatables_info}]]*/ 'info';
    var infoEmpty = /*[[#{instructor_datatables_records_infoEmpty}]]*/ 'infoEmpty';
    var infoFiltered = /*[[#{instructor_datatables_records_infoFiltered}]]*/ 'infoFiltered';
    var emptyTable = /*[[#{instructor_datatables_emptyTable}]]*/ 'emptyTable';
    var next = /*[[#{instructor_datatables_next}]]*/ 'next';
    var previous = /*[[#{instructor_datatables_previous}]]*/ 'previous';
    var sortAscending = /*[[#{instructor_datatables_sortAscending}]]*/ 'sortAscending';
    var sortDescending = /*[[#{instructor_datatables_sortDescending}]]*/ 'sortDescending';
    var auditLogExists = false;
    $('#auditLogModalButton').click(function() {
      $('#auditLogBody .spinner-border').removeClass('d-none');
      if (auditLogExists) {
        $('#auditLogTable').DataTable().clear();
        $('#auditLogTable').DataTable().destroy();
      }
      $('#auditLogTableContainer').empty();

      $.ajax({
        url: [[@{/getCourseGradeEvents}]]  + '?courseId=' + [[${courseId}]],
        type: 'POST',
        contentType: 'text/plain; charset=utf-8'
      }).done(function(response) {
        var json = [];
        $(response).each(function(idx, elem) {
          var eventDetails = JSON.parse(elem.eventDetails);
          var jsonElement = {
            'date': '<div>' + moment(elem.eventDate).format('lll') + '<span class="hiddenValue d-none">' + elem.eventDate + '</span></div>',
            'studentName': eventDetails.studentName,
            'assignmentName': eventDetails.assignmentName,
            'oldGrade': eventDetails.oldGrade,
            'newGrade': eventDetails.grade,
            'teacherName': eventDetails.teacherName
          };
          json.push(jsonElement);
        });
        $('#auditLogTableContainer').append('<table id="auditLogTable" class="table table-bordered table-striped"></table>');
        $('#auditLogBody .spinner-border').addClass('d-none');
        $('#auditLogTable').DataTable({
          data: json,
          columns: [
            {'data': 'date', 'title': messages.instructor_audit_log_date, 'type': 'hiddenValue'},
            {'data': 'studentName', 'title': messages.instructor_audit_log_student_name},
            {'data': 'assignmentName', 'title': messages.instructor_audit_log_assignment},
            {'data': 'oldGrade', 'title': messages.instructor_audit_log_old_grade},
            {'data': 'newGrade', 'title': messages.instructor_audit_log_new_grade},
            {'data': 'teacherName', 'title': messages.instructor_audit_log_instructor_name},
          ],
          order: [0, 'desc'],
          pageLength: 50,
          language: {
            'search': search,
            'lengthMenu': lengthMenu,
            'zeroRecords': zeroRecords,
            'info': info,
            'infoEmpty': infoEmpty,
            'infoFiltered': infoFiltered,
            'emptyTable': emptyTable,
            'paginate': {
              'next': next,
              'previous': previous,
            },
            'aria': {
              'sortAscending': sortAscending,
              'sortDescending': sortDescending,
            }
          }
        });
      });
      auditLogExists = true;
    });
    /**** END OF LOAD COURSE GRADE EVENTS ****/
    /*]]>*/
</script>
</body>
</html>


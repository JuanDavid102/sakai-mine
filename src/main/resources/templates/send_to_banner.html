<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <title th:text="#{banner_view_title}">Send Grades to Banner</title>
  <div th:insert="fragments/head :: head"></div>
<body>

<div class="alert alert-danger" th:if="${!userIsCourseMainInstructor}" th:text="#{banner_permission_error}">
  You are not the main instructor of this course, you are not allowed to send grades to banner.
</div>

<div class="alert alert-warning" th:if="${userIsCourseMainInstructor && bannerGrades.isEmpty()}" th:text="#{banner_no_grades}">
  The gradebook cannot load the grades from banner.
</div>

<div class="send-to-banner-container">
  <div class="mt-3 mb-3">
    <a class="canvas-btn" href="/" th:href="@{/}" th:title="#{instructor_back_gradebook}">
      <span class="fas fa-arrow-left"></span>
      <span class="d-none d-sm-inline-block" th:text="#{instructor_back_gradebook}">Back to Gradebook</span>
    </a>
  </div>
  <div th:if="${userIsCourseMainInstructor && !bannerGrades.isEmpty()}">
    <div class="alert alert-info">
      <p th:text="#{banner_info}"></p>
      <p th:text="#{banner_info_note}"></p>
    </div>
    <div class="d-flex flex-row justify-content-end mb-3">
      <button class="canvas-btn" id="sendGradesToBanner" disabled="disabled" data-toggle="modal" data-target="#bannerConfirmationModal">
        <span class="fas fa-sync"></span>
        <span class="d-none d-sm-inline-block" th:text="#{banner_button_send_grades_banner}">Send Grades to Banner</span>
      </button>
    </div>
    <div class="modal fade" id="bannerConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="sendGradesToBanner" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel" th:text="#{banner_view_title}"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" th:text="#{banner_modal_text}"></div>
          <div class="modal-footer">
            <button id="modal-button-confirm" type="button" class="btn btn-primary" th:text="#{banner_modal_confirm}">Save changes</button>
            <button id="modal-button-cancel" type="button" class="btn btn-secondary" data-dismiss="modal" th:text="#{banner_modal_cancel}">Close</button>
          </div>
        </div>
      </div>
    </div>
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th rowspan="2" class="align-middle" th:text="#{banner_header_rut}">RUT</th>
          <th rowspan="2" class="align-middle" th:text="#{banner_header_student_name}">Student Name</th>
          <th rowspan="2" class="align-middle" th:text="#{banner_header_section}">Section</th>
          <th rowspan="1" colspan="2" class="text-center" th:text="#{banner_header_grades}">Grades</th>
        </tr>
        <tr>
          <th rowspan="1" th:text="#{banner_header_canvas}">Canvas</th>
          <th rowspan="1" th:text="#{banner_header_banner}">Banner</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr th:each="user : ${courseUsers}" th:id="${'row' + user.id}">
          <td><span>
            <th:block th:if="${user.sisUserId != ''}" th:text="${user.sisUserId}"></th:block>
            <th:block th:unless="${user.sisUserId != ''}" th:text="${user.id}"></th:block>
          </span></td>
          <td><span th:text="${user.sortableName}"></span></td>
          <td><span th:text="${userSections.get(#strings.toString(user.id))}"></span></td>
          <td>
            <div th:id="${'spinnerCanvas' + user.id}" class="spinner-total spinner-border student-spinner" role="status">
              <span class="sr-only" th:text="#{instructor_spinner_loading}">Loading</span>
            </div>
            <span th:id="${'finalGrade' + user.id}"></span>
          </td>
          <td><span th:id="${'bannerGrade' + user.id}" th:text="${bannerGrades.get(user.sisUserId)}"></span></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  $(document).ready(function() {
      var courseUsers = /*[[${courseUsers}]]*/;
      var bannerGrades = /*[[${bannerGrades}]]*/;

      function calcFinalGrade(user, isCurrentGrade) {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: [[@{/getStudentFinalGrade}]] + '?studentId=' + user.id + '&isCurrentGrade=' + isCurrentGrade,
            type: 'POST',
            contentType: 'text/plain; charset=utf-8'

          }).done(function(response) {
            $('#spinnerCanvas' + user.id).addClass('d-none');
            $('#finalGrade' + user.id).text(response.grade);
            resolve(response.grade);
          });
        });
      }

      var ajaxRequests = [];
      for (var i = 0; i < courseUsers.length; i++) {
        ajaxRequests.push(calcFinalGrade(courseUsers[i], false));
      }
      var sendGradesToBannerData = [];
      Promise.all(ajaxRequests).then((arr) => {
        var newArr = [];
        while(arr.length) newArr.push(arr.splice(0, 1));
        for (var i = 0; i < courseUsers.length; i++) {
          var canvasGrade = newArr[i][0];
          var bannerGrade = bannerGrades[courseUsers[i].sisUserId];

          var studentGrade = {};
          studentGrade['userId'] = courseUsers[i].sisUserId;
          studentGrade['grade'] = canvasGrade;
          sendGradesToBannerData.push(studentGrade);

          var className = 'error';
          if (canvasGrade == bannerGrade) className = 'success';
          $('#row' + courseUsers[i].id).addClass(className);
        }
        $('#sendGradesToBanner').prop('disabled', false);
      });

      var modalConfirm = function(callback) {
        $("#modal-button-confirm").on("click", function() {
          callback(true);
          $("#bannerConfirmationModal").modal('hide');
        });

        $("#modal-button-cancel").on("click", function(){
          callback(false);
          $("#bannerConfirmationModal").modal('hide');
        });

      };

      modalConfirm( function(confirm) {
        if(confirm) {
          $('#sendGradesToBanner').prop('disabled', true);
          $('#sendGradesToBanner').find('.fas').addClass('fa-spin');
          $.ajax({
            url: /*[[@{/sendGradesToBanner}]]*/,
            data: JSON.stringify(sendGradesToBannerData),
            type: 'POST',
            contentType: 'application/json; charset=utf-8'

          }).done( function(success) {
            window.location = [[@{/send_to_banner}]];
          });
        }
      });
  });
  /*]]>*/
</script>
</body>
</html>
